@implements IDisposable

@* Advanced binding examples - demonstrates property extensions, manual binding, and state updates *@

@if (employee != null)
{
    @* begin-snippet: blazor-property-extensions *@
    <MudTextField T="string"
                  Value="@employee.Name"
                  ValueChanged="@(v => employee["Name"].SetValue(v))"
                  Error="@(!employee["Name"].IsValid)"
                  ErrorText="@GetErrorText(employee["Name"])" />
    @* end-snippet *@

    @* begin-snippet: blazor-manual-binding *@
    <MudTextField T="string"
                  Value="@employee.Name"
                  ValueChanged="@OnNameChanged"
                  Error="@(!employee["Name"].IsValid)"
                  ErrorText="@GetErrorText(employee["Name"])"
                  Disabled="@employee["Name"].IsBusy"
                  ReadOnly="@employee["Name"].IsReadOnly" />
    @* end-snippet *@
}

@* begin-snippet: blazor-statehaschanged *@
@code {
    private SkillBlazorEmployee? employee;

    [Inject]
    private ISkillBlazorEmployeeFactory EmployeeFactory { get; set; } = default!;

    protected override void OnInitialized()
    {
        employee = EmployeeFactory.Create();
        employee["Name"].PropertyChanged += OnPropertyChanged;
    }

    private void OnPropertyChanged(object? sender, PropertyChangedEventArgs e)
    {
        if (e.PropertyName is "PropertyMessages" or "IsValid" or "IsBusy" or "IsReadOnly")
        {
            InvokeAsync(StateHasChanged);
        }
    }

    public void Dispose()
    {
        if (employee != null)
        {
            employee["Name"].PropertyChanged -= OnPropertyChanged;
        }
    }

    private async Task OnNameChanged(string value)
    {
        await employee!["Name"].SetValue(value);
    }

    private string GetErrorText(IValidateProperty property)
    {
        return string.Join("; ", property.PropertyMessages.Select(m => m.Message));
    }
}
@* end-snippet *@
