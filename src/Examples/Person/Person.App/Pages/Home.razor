@page "/"

@using Neatoo
@using DomainModel
@inject IPersonFactory PersonFactory
@inject IUser User

<MudContainer MaxWidth="MaxWidth.Medium">
    <MudPaper Class="pa-4">
        <MudText Typo="Typo.h4" Class="mb-4">User Role:</MudText>

        <MudRadioGroup @bind-Value="selectedRole">
            <MudRadio Value="Role.None" Color="Color.Primary">None</MudRadio>
            <MudRadio Value="Role.Create" Color="Color.Primary">Create</MudRadio>
            <MudRadio Value="Role.Fetch" Color="Color.Primary">Fetch</MudRadio>
            <MudRadio Value="Role.Update" Color="Color.Primary">Update</MudRadio>
            <MudRadio Value="Role.Delete" Color="Color.Primary">Delete</MudRadio>
        </MudRadioGroup>

        <MudText Typo="Typo.h4" Class="my-4">Person</MudText>

        @if (Person == null)
        {
            <MudText Typo="Typo.body1">Not loaded</MudText>
        }
        else if (!string.IsNullOrEmpty(Message))
        {
            <MudText Typo="Typo.body1">@Message</MudText>
        }
        else
        {
            <MudForm @ref="form" @bind-IsValid="@formIsValid">
                <!-- Page-Level Validation Summary -->
                <NeatooValidationSummary Entity="@Person" Class="mb-4" />

                <MudNeatooTextField T="string" EntityProperty="@Person["FirstName"]" Class="mb-3" />

                <MudNeatooTextField T="string" EntityProperty="@Person["LastName"]" Class="mb-3" />

                <MudNeatooTextField T="string" EntityProperty="@Person["Email"]" Class="mb-3" />

                <MudText Typo="Typo.h5" Class="my-3">Phone Numbers</MudText>
                <MudButton Variant="Variant.Filled"
                          Color="Color.Primary"
                          OnClick="AddPhone"
                          StartIcon="@Icons.Material.Filled.Add"
                          Size="Size.Small"
                          Class="mb-3">
                    Add Phone
                </MudButton>

                @foreach (var phone in Person.PersonPhoneList)
                {
                    <MudGrid Class="mb-2" Spacing="2">
                        <MudItem xs="12" sm="4">
                            <MudNeatooSelect T="PhoneType?"
                                            EntityProperty="@phone[nameof(IPersonPhone.PhoneType)]"
                                            Placeholder="Select Phone Type">
                                <MudSelectItem Value="@((PhoneType?)PhoneType.Home)">Home</MudSelectItem>
                                <MudSelectItem Value="@((PhoneType?)PhoneType.Mobile)">Mobile</MudSelectItem>
                                <MudSelectItem Value="@((PhoneType?)PhoneType.Work)">Work</MudSelectItem>
                            </MudNeatooSelect>
                        </MudItem>
                        <MudItem xs="10" sm="6">
                            <MudNeatooTextField T="string" EntityProperty="@phone[nameof(IPersonPhone.PhoneNumber)]" />
                        </MudItem>
                        <MudItem xs="2" sm="2" Class="d-flex align-center">
                            <MudIconButton Icon="@Icons.Material.Filled.Delete"
                                          Color="Color.Error"
                                          Size="Size.Medium"
                                          OnClick="() => RemovePhone(phone)" />
                        </MudItem>
                    </MudGrid>
                }

                <MudNeatooTextField T="string" EntityProperty="@Person["Notes"]"
                                   Lines="3"
                                   Class="mb-3" />

                <MudStack Row="true" Spacing="2" Class="mt-4">
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Primary"
                              OnClick="HandleSubmit"
                              Disabled="@(!Person.IsSavable)">
                        Update
                    </MudButton>
                    <MudButton Variant="Variant.Filled"
                              Color="Color.Error"
                              OnClick="Delete"
                              Disabled="@(!CanDelete)">
                        Delete
                    </MudButton>
                </MudStack>
            </MudForm>
        }

        <MudStack Row="true" Spacing="2" Class="mt-4">
            <MudButton Variant="Variant.Outlined" OnClick="Clear">Clear</MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="Create" Disabled="@(!CanCreate)">Create</MudButton>
            <MudButton Variant="Variant.Outlined" OnClick="Fetch" Disabled="@(!CanFetch)">Fetch</MudButton>
        </MudStack>
    </MudPaper>
</MudContainer>

@code {
    private MudForm? form;

    public IPerson? Person { get; set; } = default!;
    public string Message { get; set; } = "Not Loaded";
    private bool formIsValid;

    private bool CanCreate { get; set; }
    private bool CanFetch { get; set; }
    private bool CanUpdate { get; set; }
    private bool CanDelete { get; set; }
    private Role _selectedRole = Role.None;
    public Role selectedRole
    {
        get => _selectedRole;
        set
        {
            _selectedRole = value;
            UserRoleChanged();
        }
    }

    [Inject(Key = Neatoo.RemoteFactory.RemoteFactoryServices.HttpClientKey)]
    private HttpClient httpClient { get; set; } = default!;

    private void Clear()
    {
        NewPerson(null);
    }


    private async Task Create()
    {
        NewPerson(PersonFactory.Create());
        Message = string.Empty;
    }


    private async Task Fetch()
    {
        Message = "Fetching...";
        NewPerson(await PersonFactory.Fetch(CancellationToken.None));
        Message = string.Empty;
    }

    private async Task Delete()
    {
        this.Person!.Delete();
        await PersonFactory.Save(Person!, CancellationToken.None);
        this.Person = null;
    }

    private async Task HandleSubmit()
    {
        if (Person == null)
            return;

        // Validate all fields - this shows errors on fields user hasn't touched
        await form!.Validate();

        // Wait for any async rules to complete
        await Person.WaitForTasks();
        await Person.RunRules(RunRulesFlag.NotExecuted);

        // Re-validate after async rules complete to show any new errors
        await form!.Validate();

        if (!Person.IsSavable)
        {
            Message = "Please fix the errors above";
            await Task.Delay(2000);
            Message = string.Empty;
            return;
        }

        Message = "Saving...";
        NewPerson(await PersonFactory.Save(Person!, CancellationToken.None));
        Message = string.Empty;
    }

    private void NewPerson(IPerson? personModel)
    {
        if (Person != null)
        {
            Person.PropertyChanged -= PersonPropertyChanged;
        }

        Person = personModel;

        if (Person != null)
        {
            Person.PropertyChanged += PersonPropertyChanged;
        }
    }

    private void PersonPropertyChanged(object? sender, System.ComponentModel.PropertyChangedEventArgs e)
    {
        if (e.PropertyName?.StartsWith("Is") == true)
        {
            InvokeAsync(() => StateHasChanged());
        }
    }

    private void UserRoleChanged()
    {
        httpClient.DefaultRequestHeaders.Remove("UserRoles");
        httpClient.DefaultRequestHeaders.Add("UserRoles", selectedRole.ToString());
        if (selectedRole == Role.None)
        {
            Person = null;
        }

        User.Role = selectedRole;
        CanCreate = PersonFactory.CanCreate();
        CanFetch = PersonFactory.CanFetch();
        CanUpdate = PersonFactory.CanUpdate();
        CanDelete = PersonFactory.CanDelete();
    }

    private void AddPhone()
    {
        Person!.PersonPhoneList.AddPhoneNumber();
    }

    private Task RemovePhone(IPersonPhone personPhoneModel)
    {
        return Person!.PersonPhoneList.RemovePhoneNumber(personPhoneModel);
    }
}
