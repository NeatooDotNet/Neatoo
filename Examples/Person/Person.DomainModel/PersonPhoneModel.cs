using Neatoo;
using Neatoo.RemoteFactory;
using Neatoo.Rules;
using Neatoo.Rules.Rules;
using Person.Ef;
using System.ComponentModel;
using System.ComponentModel.DataAnnotations;

namespace Person.DomainModel
{
    public enum PhoneType
    {
        Home,
        Work,
        Mobile
    }

    public partial interface IPersonPhoneModel : IIdEditBase
    {
        // Not Empty - Properties auto-generated by BaseGenerator (Roslyn)
        IPersonModel? ParentPersonModel { get; }
    }

    [Factory]
    internal partial class PersonPhoneModel : IdEditBase<PersonPhoneModel>, IPersonPhoneModel
    {
        [Create]
        public PersonPhoneModel([Service] IUniquePhoneNumberRule uniquePhoneNumberRule,
                        [Service] IUniquePhoneTypeRule uniquePhoneTypeRule,
            [Service] IEditBaseServices<PersonPhoneModel> services) : base(services)
        {
            RuleManager.AddRule(uniquePhoneNumberRule);
            RuleManager.AddRule(uniquePhoneTypeRule);
        }

        [Required(ErrorMessage = "Phone number type is required")]
        public partial PhoneType? PhoneType { get; set; }

        [DisplayName("Phone Number*")]
        [Required(ErrorMessage = "Phone number is required")]
        public partial string? PhoneNumber { get; set; }

        public IPersonModel? ParentPersonModel => this.Parent as IPersonModel;

        public partial void MapFrom(PersonPhoneEntity personPhoneEntity);
        public partial void MapTo(PersonPhoneEntity personPhoneEntity);

        [Fetch]
        public void Fetch(PersonPhoneEntity personPhoneEntity)
        {
            MapFrom(personPhoneEntity);
        }

        [Insert]
        [Update]
        public void Update(PersonPhoneEntity personPhoneEntity)
        {
            MapTo(personPhoneEntity);

            if(Id == null)
            {
                personPhoneEntity.PropertyChanged += HandleIdPropertyChanged;
            }
        }
    }

    public interface IPersonPhoneModelList : IEditListBase<IPersonPhoneModel>
    {
        IPersonPhoneModel AddPhoneNumber();
        Task RemovePhoneNumber(IPersonPhoneModel personPhoneModel);
    }

    [Factory]
    internal class PersonPhoneModelList : EditListBase<IPersonPhoneModel>, IPersonPhoneModelList
    {
        private readonly IPersonPhoneModelFactory personPhoneModelFactory;

        public PersonPhoneModelList([Service] IPersonPhoneModelFactory personPhoneModelFactory)
        {
            this.personPhoneModelFactory = personPhoneModelFactory;
        }

        public IPersonPhoneModel AddPhoneNumber()
        {
            var personPhoneModel = personPhoneModelFactory.Create();
            Add(personPhoneModel);
            return personPhoneModel;
        }

        public async Task RemovePhoneNumber(IPersonPhoneModel personPhoneModel)
        {
            this.Remove(personPhoneModel);
            await RunRules();
        }

        protected override async Task HandleNeatooPropertyChanged(NeatooPropertyChangedEventArgs breadCrumbs)
        {
            await base.HandleNeatooPropertyChanged(breadCrumbs);

            if ((breadCrumbs.PropertyName == nameof(IPersonPhoneModel.PhoneType) ||
                breadCrumbs.PropertyName == nameof(IPersonPhoneModel.PhoneNumber)))
            {
                if (breadCrumbs.Source is IPersonPhoneModel personPhoneModel)
                {
                    await Task.WhenAll(this.Except([personPhoneModel])
                        .Select(c => c.RunRules()));
                }
            }
        }

        [Fetch]
        public void Fetch(IEnumerable<PersonPhoneEntity> personPhoneEntities,
                            [Service] IPersonPhoneModelFactory personPhoneModelFactory)
        {
            foreach (var personPhoneEntity in personPhoneEntities)
            {
                var personPhoneModel = personPhoneModelFactory.Fetch(personPhoneEntity);
                this.Add(personPhoneModel);
            }
        }

        [Update]
        public void Update(ICollection<PersonPhoneEntity> personPhoneEntities,
                            [Service] IPersonPhoneModelFactory personPhoneModelFactory)
        {
            foreach (var personPhoneModel in this.Union(DeletedList))
            {
                PersonPhoneEntity? personPhoneEntity = null;

                if (personPhoneModel.Id.HasValue)
                {
                    personPhoneEntity = personPhoneEntities.Single(x => x.Id == personPhoneModel.Id);
                }
                else
                {
                    personPhoneEntity = new PersonPhoneEntity();
                    personPhoneEntities.Add(personPhoneEntity);
                }

                if (personPhoneModel.IsDeleted)
                {
                    personPhoneEntities.Remove(personPhoneEntity);
                }
                else
                {
                    personPhoneModelFactory.Save(personPhoneModel, personPhoneEntity);
                }
            }
        }
    }

    internal interface IUniquePhoneNumberRule : IRule<IPersonPhoneModel>
    {

    }

    internal class UniquePhoneNumberRule : RuleBase<IPersonPhoneModel>, IUniquePhoneNumberRule
    {
        public UniquePhoneNumberRule()
        {
            AddTriggerProperties(p => p.PhoneType, p => p.PhoneNumber);
        }

        protected override IRuleMessages Execute(IPersonPhoneModel target)
        {
            return RuleMessages.If(target.ParentPersonModel == null, nameof(IPersonPhoneModel.PhoneType), "Parent is null")
                .If(target.ParentPersonModel == null, nameof(IPersonPhoneModel.PhoneNumber), "Parent is null")
                .ElseIf(() => target.ParentPersonModel!.PersonPhoneModelList
                            .Where(c => c != target)
                            .Any(c => c.PhoneNumber == target.PhoneNumber), nameof(IPersonPhoneModel.PhoneNumber), "Phone number must be unique");
        }
    }

    internal interface IUniquePhoneTypeRule : IRule<IPersonPhoneModel>
    {

    }

    internal class UniquePhoneTypeRule : RuleBase<IPersonPhoneModel>, IUniquePhoneTypeRule
    {
        public UniquePhoneTypeRule()
        {
            AddTriggerProperties(p => p.PhoneType, p => p.PhoneNumber);
        }

        protected override IRuleMessages Execute(IPersonPhoneModel target)
        {
            return RuleMessages.If(target.ParentPersonModel == null, nameof(IPersonPhoneModel.PhoneType), "Parent is null")
                .If(target.ParentPersonModel == null, nameof(IPersonPhoneModel.PhoneNumber), "Parent is null")
                .ElseIf(() => target.ParentPersonModel!.PersonPhoneModelList
                            .Where(c => c != target)
                            .Any(c => c.PhoneType == target.PhoneType), nameof(IPersonPhoneModel.PhoneType), "Phone type must be unique");
        }
    }
}
