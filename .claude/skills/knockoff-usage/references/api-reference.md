# KnockOff Interceptor API Reference

This document provides a complete API reference for all interceptor types generated by KnockOff. Interceptors track calls, manage state, and configure callback behavior for stub members.

---

## Overview

KnockOff generates five types of interceptors, each exposed through properties named after the interface:

| Interceptor Type | Generated For | Container Property |
|-----------------|---------------|-------------------|
| **Method Interceptor** | Interface methods (non-generic) | `{Interface}.{MethodName}` |
| **Generic Method Interceptor** | Generic interface methods | `{Interface}.{MethodName}` |
| **Property Interceptor** | Interface properties | `{Interface}.{PropertyName}` |
| **Indexer Interceptor** | Interface indexers | `{Interface}.Indexer` |
| **Event Interceptor** | Interface events | `{Interface}.{EventName}` |

All interceptors provide a `Reset()` method to clear tracking state and callbacks.

---

## Method Interceptor

Generated for non-generic interface methods. Tracks call counts, captures arguments, and supports callback configuration.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `LastCallArg` | `T` | The argument from the most recent call (single-parameter methods only) |
| `LastCallArgs` | `(T1, T2, ...)` | Tuple of arguments from the most recent call (multi-parameter methods) |
| `OnCall` | Delegate | Callback invoked when the method is called |

### Verification Methods

| Method | Description |
|--------|-------------|
| `Verify()` | Verify method was called at least once (throws if not) |
| `Verify(Times)` | Verify method was called according to Times constraint |
| `Verifiable()` | Mark interceptor for batch verification with default constraint (AtLeastOnce) |
| `Verifiable(Times)` | Mark interceptor for batch verification with specific Times constraint |

### OnCall Signatures

The `OnCall` property type varies based on method signature:

| Method Signature | OnCall Type |
|-----------------|-------------|
| `void M()` | `Action` |
| `void M(T arg)` | `Action<T>` |
| `void M(T1 a, T2 b)` | `Action<T1, T2>` |
| `R M()` | `Func<R>` |
| `R M(T arg)` | `Func<T, R>` |
| `R M(T1 a, T2 b)` | `Func<T1, T2, R>` |

When `OnCall` is set, the callback is invoked instead of user-defined methods. For `Func<>` callbacks, the return value is used as the method result.

### Methods

- `void Reset()` - Clears tracking state, `LastCallArg`, `LastCallArgs`, and `OnCall`

### Example

```cs
[Fact]
public void MethodInterceptor_CompleteApiDemonstration()
{
    var stub = new ApiMethodRepoStub();

    // Configure void method with OnCall and mark verifiable
    var saveTracking = stub.Save.OnCall((user) => { }).Verifiable();

    // Configure return method with OnCall and mark verifiable
    var getTracking = stub.GetById.OnCall((id) =>
        new User { Id = id, Name = $"User{id}" }).Verifiable();

    // Configure multi-parameter method and mark verifiable
    var updateTracking = stub.Update.OnCall((id, name) => { }).Verifiable();

    IApiMethodRepo repository = stub;

    // Exercise the stub
    repository.Save(new User { Id = 1, Name = "Alice" });
    var user = repository.GetById(42);
    repository.Update(1, "UpdatedName");

    // Verify all methods were called
    stub.Verify();

    // Access last argument (single parameter) via tracking
    Assert.Equal(42, getTracking.LastArg);

    // Access last arguments (multi parameter via tracking)
    var (id, name) = updateTracking.LastArgs;
    Assert.Equal(1, id);
    Assert.Equal("UpdatedName", name);

    // Verify return value was computed by callback
    Assert.NotNull(user);
    Assert.Equal("User42", user.Name);
}
```

---

## Property Interceptor

Generated for interface properties. Tracks get/set operations, stores backing values, and supports get/set callbacks.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Value` | `T` | Backing value returned by property getter |
| `LastSetValue` | `T` | The value from the most recent setter call |
| `OnGet` | `Func<T>` | Callback invoked when the property is read |
| `OnSet` | `Action<T>` | Callback invoked when the property is written |

### Verification Methods

| Method | Description |
|--------|-------------|
| `VerifyGet()` | Verify property getter was called at least once (throws if not) |
| `VerifyGet(Times)` | Verify property getter was called according to Times constraint |
| `VerifySet()` | Verify property setter was called at least once (throws if not) |
| `VerifySet(Times)` | Verify property setter was called according to Times constraint |
| `MarkVerifiableGet()` | Mark getter for batch verification with default constraint (AtLeastOnce) |
| `MarkVerifiableGet(Times)` | Mark getter for batch verification with specific Times constraint |
| `MarkVerifiableSet()` | Mark setter for batch verification with default constraint (AtLeastOnce) |
| `MarkVerifiableSet(Times)` | Mark setter for batch verification with specific Times constraint |

### Behavior Notes

- **OnGet replaces Value**: When `OnGet` is set, the callback's return value is used instead of `Value`
- **OnSet doesn't update Value**: Setting `OnSet` does NOT automatically update `Value`. If you want `Value` updated, your callback must do it explicitly
- **Init-only properties**: Setters for `init` properties are tracked like regular setters

### Methods

- `void Reset()` - Clears tracking state, `LastSetValue`, `OnGet`, and `OnSet`. Does NOT reset `Value`

### Example

```cs
[Fact]
public void PropertyInterceptor_CompleteApiDemonstration()
{
    var stub = new ApiPropertyRepoStub();

    // Set Value directly - returned by getter
    stub.ConnectionString.Value = "Server=localhost";

    IApiPropertyRepo repository = stub;

    // Read property - uses Value
    var conn = repository.ConnectionString;
    Assert.Equal("Server=localhost", conn);

    // Verify property was read
    stub.ConnectionString.VerifyGet(Times.Once);

    // Write property
    repository.ConnectionString = "Server=production";

    // Verify property was written
    stub.ConnectionString.VerifySet(Times.Once);

    // LastSetValue captures what was written
    Assert.Equal("Server=production", stub.ConnectionString.LastSetValue);

    // OnGet replaces Value with callback return
    // Note: OnGet takes the stub as first parameter (ko)
    stub.Timeout.OnGet = () => 30;
    var timeout = repository.Timeout;
    Assert.Equal(30, timeout);

    // OnSet provides custom setter behavior
    // Note: OnSet takes (value) - does NOT automatically update Value
    var setWasCalled = false;
    stub.Timeout.OnSet = (val) =>
    {
        setWasCalled = true;
        // Manually update Value if needed:
        // stub.Timeout.Value = val;
    };
    repository.Timeout = 60;
    Assert.True(setWasCalled);
    // Value is NOT updated because OnSet didn't do it
    // (OnGet returns 30 from callback, not Value)
}
```

---

## Indexer Interceptor

Generated for interface indexers. Maintains a backing dictionary, tracks get/set operations, and supports indexed callbacks.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `Backing` | `Dictionary<TKey, TValue>` | Backing dictionary used by default get/set operations |
| `LastGetKey` | `TKey` | The key from the most recent getter call |
| `LastSetEntry` | `(TKey, TValue)` | Tuple of key and value from the most recent setter call |
| `OnGet` | `Func<TKey, TValue>` | Callback invoked when the indexer is read |
| `OnSet` | `Action<TKey, TValue>` | Callback invoked when the indexer is written |

### Verification Methods

| Method | Description |
|--------|-------------|
| `VerifyGet()` | Verify indexer getter was called at least once (throws if not) |
| `VerifyGet(Times)` | Verify indexer getter was called according to Times constraint |
| `VerifySet()` | Verify indexer setter was called at least once (throws if not) |
| `VerifySet(Times)` | Verify indexer setter was called according to Times constraint |

### Behavior Notes

- **Backing dictionary**: By default, get returns `Backing[key]` and set stores to `Backing[key]`
- **OnGet override**: When `OnGet` is set, the callback's return value is used instead of `Backing`
- **OnSet override**: When `OnSet` is set, the callback is invoked. `Backing` is NOT updated automatically unless your callback does it

### Methods

- `void Reset()` - Clears tracking state, `LastGetKey`, `LastSetEntry`, `OnGet`, and `OnSet`. Does NOT clear `Backing`

### Example

```cs
[Fact]
public void IndexerInterceptor_CompleteApiDemonstration()
{
    var stub = new ApiIndexerRepoStub();

    // Populate Backing dictionary directly
    stub.Indexer.Backing[1] = new User { Id = 1, Name = "Alice" };
    stub.Indexer.Backing[2] = new User { Id = 2, Name = "Bob" };

    IApiIndexerRepo repository = stub;

    // Read from indexer - uses Backing by default
    var user1 = repository[1];
    Assert.NotNull(user1);
    Assert.Equal("Alice", user1.Name);

    // Verify indexer was read
    stub.Indexer.VerifyGet(Times.Once);

    // LastGetKey captures the key used
    Assert.Equal(1, stub.Indexer.LastGetKey);

    // Write to indexer - updates Backing by default
    repository[3] = new User { Id = 3, Name = "Charlie" };

    // Verify indexer was written
    stub.Indexer.VerifySet(Times.Once);

    // LastSetEntry captures key and value (nullable tuple)
    var lastEntry = stub.Indexer.LastSetEntry;
    Assert.NotNull(lastEntry);
    Assert.Equal(3, lastEntry.Value.Key);
    Assert.Equal("Charlie", lastEntry.Value.Value?.Name);

    // OnGet overrides Backing lookup
    // Note: OnGet takes (key)
    stub.Indexer.OnGet = (k) => new User { Id = k, Name = "FromCallback" };
    var fromCallback = repository[999];
    Assert.Equal("FromCallback", fromCallback?.Name);

    // OnSet overrides Backing storage
    // Note: OnSet takes (key, value) - does NOT automatically update Backing
    var onSetCalled = false;
    stub.Indexer.OnSet = (k, v) =>
    {
        onSetCalled = true;
        // Manually update Backing if needed:
        // stub.Indexer.Backing[k] = v;
    };
    repository[4] = new User { Id = 4, Name = "Dave" };
    Assert.True(onSetCalled);
    // Backing[4] is NOT set because OnSet didn't do it
    Assert.False(stub.Indexer.Backing.ContainsKey(4));
}
```

---

## Event Interceptor

Generated for interface events. Tracks add/remove operations, checks for subscribers, and provides `Raise` methods for firing events.

### Properties

| Property | Type | Description |
|----------|------|-------------|
| `HasSubscribers` | `bool` | True if there are currently active subscribers |

### Verification Methods

| Method | Description |
|--------|-------------|
| `VerifyAdd()` | Verify event was subscribed at least once (throws if not) |
| `VerifyAdd(Times)` | Verify event was subscribed according to Times constraint |
| `VerifyRemove()` | Verify event was unsubscribed at least once (throws if not) |
| `VerifyRemove(Times)` | Verify event was unsubscribed according to Times constraint |

### Methods

#### Raise Methods

The `Raise` method signature varies based on the event delegate type:

| Event Delegate | Raise Signature |
|---------------|-----------------|
| `Action` | `void Raise()` |
| `Action<T>` | `void Raise(T arg)` |
| `Action<T1, T2>` | `void Raise(T1 arg1, T2 arg2)` |
| `EventHandler` | `void Raise(object sender, EventArgs e)` |
| `EventHandler<TArgs>` | `void Raise(object sender, TArgs e)` |

Calling `Raise` invokes all subscribed handlers with the provided arguments.

#### Reset

- `void Reset()` - Clears tracking state. Does NOT remove subscribers

### Example

```cs
[Fact]
public void EventInterceptor_CompleteApiDemonstration()
{
    var stub = new ApiEventRepoStub();
    IApiEventRepo repository = stub;

    // Subscribe to EventHandler event
    var changedInvoked = false;
    repository.Changed += (sender, e) => changedInvoked = true;

    // Verify subscription occurred
    stub.Changed.VerifyAdd(Times.Once);

    // HasSubscribers indicates active subscriptions
    Assert.True(stub.Changed.HasSubscribers);

    // Raise fires all subscribers
    stub.Changed.Raise(repository, EventArgs.Empty);
    Assert.True(changedInvoked);

    // Unsubscribe
    EventHandler handler = (sender, e) => { };
    repository.Changed += handler;
    stub.Changed.VerifyAdd(Times.Exactly(2));

    repository.Changed -= handler;
    stub.Changed.VerifyRemove(Times.Once);

    // Action<T> events work similarly
    User? addedUser = null;
    repository.UserAdded += user => addedUser = user;

    // Raise with typed argument
    stub.UserAdded.Raise(new User { Id = 1, Name = "Alice" });
    Assert.NotNull(addedUser);
    Assert.Equal("Alice", addedUser.Name);
}
```

---

## Generic Method Interceptor

Generated for generic interface methods. Provides base-level tracking across all type arguments and typed access via `.Of<T>()` for specific type argument tracking.

### Base Properties

Available directly on the interceptor instance:

| Property | Type | Description |
|----------|------|-------------|
| `CalledTypeArguments` | `IReadOnlyList<Type>` | List of all type arguments used in calls (in order of first use) |

### Typed Access

Call `.Of<T>()` (or `.Of<T1, T2>()` for multiple type parameters) to get a typed interceptor for specific type arguments.

#### Typed Properties

| Property | Type | Description |
|----------|------|-------------|
| `LastCallArg` | `TArg` | The argument from the most recent call with these type arguments (single-parameter methods) |
| `LastCallArgs` | `(TArg1, TArg2, ...)` | Tuple of arguments from the most recent call (multi-parameter methods) |
| `OnCall` | Delegate | Callback invoked when the method is called with these type arguments |

The `OnCall` property follows the same signature rules as non-generic method interceptors (see Method Interceptor section).

### Methods

- **Base Reset**: `void Reset()` - Clears all tracking and callbacks across all type arguments
- **Typed Reset**: `void Of<T>().Reset()` - Clears tracking and callback only for the specific type argument(s)

### Example

```cs
[Fact]
public void GenericMethodInterceptor_CompleteApiDemonstration()
{
    var stub = new ApiGenericRepoStub();

    // Configure OnCall for specific type arguments
    var userTracking = stub.GetById.Of<User>().OnCall((id) =>
        new User { Id = id, Name = $"User{id}" });

    var productTracking = stub.GetById.Of<Product>().OnCall((id) =>
        new Product { Id = id, Name = $"Product{id}" });

    IApiGenericRepo repository = stub;

    // Call with different type arguments
    var user = repository.GetById<User>(1);
    var product = repository.GetById<Product>(2);
    var user2 = repository.GetById<User>(3);

    // Verify calls via tracking with Times
    userTracking.Verify(Times.Exactly(2));
    productTracking.Verify(Times.Once);

    // CalledTypeArguments lists all types used
    Assert.Contains(typeof(User), stub.GetById.CalledTypeArguments);
    Assert.Contains(typeof(Product), stub.GetById.CalledTypeArguments);

    // LastCallArg for specific type (captures the 'id' parameter)
    Assert.Equal(3, stub.GetById.Of<User>().LastCallArg);
    Assert.Equal(2, stub.GetById.Of<Product>().LastCallArg);

    // Reset typed tracking only
    stub.GetById.Of<User>().Reset();
    stub.GetById.Of<User>().Verify(Times.Never);
    productTracking.Verify(Times.Once); // Preserved

    // Reset all tracking
    stub.GetById.Reset();
    stub.GetById.Of<User>().Verify(Times.Never);
    stub.GetById.Of<Product>().Verify(Times.Never);
}
```

---

## Reset Behavior Summary

All interceptors provide a `Reset()` method. This table summarizes what each reset clears and preserves:

| Interceptor Type | Reset Clears | Reset Preserves |
|-----------------|--------------|-----------------|
| **Method** | Tracking state, `LastCallArg`, `LastCallArgs`, `OnCall` | N/A |
| **Property** | Tracking state, `LastSetValue`, `OnGet`, `OnSet` | `Value` |
| **Indexer** | Tracking state, `LastGetKey`, `LastSetEntry`, `OnGet`, `OnSet` | `Backing` dictionary |
| **Event** | Tracking state | Active subscribers |
| **Generic Method (Base)** | All tracking and callbacks across all type arguments | N/A |
| **Generic Method (Typed)** | Tracking and callback for specific type argument(s) only | Tracking for other type arguments |

**Key Principle**: `Reset()` clears tracking and callbacks, but preserves state that represents "what the stub currently is" (property values, backing dictionaries, event subscribers).

---

## Times Constraint Reference

The `Times` struct is used with verification methods to specify expected call counts:

| Times Method | Description |
|-------------|-------------|
| `Times.Never` | Expected to not be called (0 times) |
| `Times.Once` | Expected to be called exactly once |
| `Times.AtLeastOnce` | Expected to be called one or more times |
| `Times.AtMostOnce` | Expected to be called zero or one time |
| `Times.Exactly(n)` | Expected to be called exactly n times |
| `Times.AtLeast(n)` | Expected to be called n or more times |
| `Times.AtMost(n)` | Expected to be called n or fewer times |
| `Times.Between(min, max)` | Expected to be called between min and max times (inclusive) |

### Example

```cs
// Verify exact call counts
stub.Save.Verify(Times.Exactly(3));

// Verify range
stub.GetById.Verify(Times.Between(1, 5));

// Verify not called
stub.Delete.Verify(Times.Never);

// Mark for batch verification
stub.Save.Verifiable(Times.AtLeastOnce);
stub.GetById.Verifiable(Times.Once);
stub.Verify(); // Verifies all marked interceptors
```

---

## Batch Verification

Stub classes provide a `Verify()` method that validates all interceptors marked as verifiable in a single call.

### Workflow

1. Mark interceptors using `Verifiable()` or `Verifiable(Times)`
2. Exercise the stub through the interface
3. Call `stub.Verify()` to validate all marked interceptors at once

### Example

```cs
var stub = new UserRepoStub();

// Mark interceptors for batch verification
stub.Save.Verifiable();
stub.GetById.Verifiable(Times.AtLeastOnce);
stub.Delete.Verifiable(Times.Never);

IUserRepo repo = stub;

// Exercise the stub
repo.Save(new User { Id = 1 });
repo.GetById(1);

// Verify all at once - throws if any constraint fails
stub.Verify();
```

If any verification fails, `Verify()` throws an exception detailing which interceptors failed and why.
