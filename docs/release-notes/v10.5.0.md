# Neatoo 10.5.0

**Release Date:** 2026-01-04
**Type:** Feature Release
**Breaking Changes:** No

---

## Summary

This release adds comprehensive CancellationToken support across all async operations in Neatoo. Validation, rule execution, and entity save operations can now be cancelled, with proper cleanup that marks objects as invalid when cancellation occurs.

**Design principle:** Cancellation is for stopping, not recovering. When cancelled, objects are marked invalid and require `RunRules(RunRulesFlag.All)` to recover.

---

## What's New

### WaitForTasks with CancellationToken

All async waiting operations now accept an optional `CancellationToken`:

```csharp
// Cancel waiting for async validation
var cts = new CancellationTokenSource();
cts.CancelAfter(TimeSpan.FromSeconds(5));

try
{
    await employee.WaitForTasks(cts.Token);
}
catch (OperationCanceledException)
{
    // Waiting was cancelled - running tasks may still complete
}
```

Available on:
- `AsyncTasks.WaitForCompletion(CancellationToken?)`
- `ValidateBase<T>.WaitForTasks(CancellationToken)`
- `ValidateListBase<I>.WaitForTasks(CancellationToken)`
- `IValidateMetaProperties.WaitForTasks(CancellationToken)`

### Cancellable Rule Execution

`RunRules()` now checks for cancellation before each rule execution:

```csharp
var cts = new CancellationTokenSource();

// Start validation
var task = employee.RunRules();

// Cancel mid-validation
cts.Cancel();

// Object is marked invalid with message "Validation cancelled"
Assert.IsFalse(employee.IsValid);
```

When `RunRules()` is cancelled:
1. The current rule completes (never interrupted mid-execution)
2. Remaining rules are skipped
3. `MarkInvalid("Validation cancelled")` is called
4. `OperationCanceledException` is caught internally (not thrown to caller)

### Cancellable Entity Save

`EntityBase<T>.Save()` now accepts a `CancellationToken`:

```csharp
var cts = new CancellationTokenSource();
cts.CancelAfter(TimeSpan.FromSeconds(30));

try
{
    await employee.Save(cts.Token);
}
catch (OperationCanceledException)
{
    // Save was cancelled before persistence started
}
```

**Important:** Cancellation only takes effect *before* persistence begins. Once the `[Insert]`/`[Update]`/`[Delete]` factory method starts executing, it runs to completion. This prevents partial writes and data corruption.

### Async Fluent Rules with CancellationToken

New fluent rule overloads that pass `CancellationToken` to your async logic:

```csharp
// Action rule with cancellation support
RuleManager.AddActionAsync<IEmployee>(
    async (employee, token) =>
    {
        await SomeLongRunningOperation(token);
    },
    e => e.Email);

// Validation rule with cancellation support
RuleManager.AddValidationAsync<IEmployee>(
    async (employee, token) =>
    {
        var isValid = await ValidateWithService(employee.Email, token);
        return isValid ? null : "Email validation failed";
    },
    e => e.Email);
```

New fluent rule classes:
- `ActionAsyncFluentRuleWithToken<T>` - async action rules with `CancellationToken`
- `AsyncFluentRuleWithToken<T>` - async validation rules with `CancellationToken`

---

## Design Philosophy

### Cancellation Semantics

| Principle | Behavior |
|-----------|----------|
| Running tasks complete | Cancellation only stops *waiting*, not in-flight operations |
| Object becomes invalid | `MarkInvalid("Validation cancelled")` called on cancellation |
| No partial states | Rules either complete fully or don't start |
| Explicit recovery required | Must call `RunRules(RunRulesFlag.All)` to revalidate |

### Why Not Throw to Caller?

When `RunRules()` is cancelled, the exception is caught internally rather than propagated. This ensures:

1. UI code doesn't need try/catch around every validation
2. The object is in a predictable state (invalid with message)
3. Recovery path is clear and consistent

### Save Cancellation Safety

`Save()` cancellation is intentionally limited to the pre-persistence phase:

```
[Start Save]
    |
    v
[RunRules] <-- Cancellable
    |
    v
[WaitForTasks] <-- Cancellable
    |
    v
[Call Factory Method] <-- NOT cancellable (data safety)
    |
    v
[Complete]
```

---

## API Reference

### New Method Overloads

| Method | Signature |
|--------|-----------|
| `IValidateMetaProperties.WaitForTasks` | `Task WaitForTasks(CancellationToken token)` |
| `ValidateBase<T>.WaitForTasks` | `Task WaitForTasks(CancellationToken token)` |
| `ValidateListBase<I>.WaitForTasks` | `Task WaitForTasks(CancellationToken token)` |
| `EntityBase<T>.Save` | `Task<T?> Save(CancellationToken token = default)` |

### New Fluent Rule Methods

| Method | Signature |
|--------|-----------|
| `RuleManager.AddActionAsync` | `void AddActionAsync<T>(Func<T, CancellationToken, Task> action, params Expression<Func<T, object?>>[] triggers)` |
| `RuleManager.AddValidationAsync` | `void AddValidationAsync<T>(Func<T, CancellationToken, Task<string?>> validation, params Expression<Func<T, object?>>[] triggers)` |

### New Classes

| Class | Purpose |
|-------|---------|
| `ActionAsyncFluentRuleWithToken<T>` | Fluent async action rule with `CancellationToken` support |
| `AsyncFluentRuleWithToken<T>` | Fluent async validation rule with `CancellationToken` support |

---

## Migration Guide

### For Application Developers

**No action required.** All new APIs have default parameter values or are new overloads. Existing code continues to work without modification.

### To Adopt Cancellation Support

1. **For long-running validation:** Pass `CancellationToken` to `WaitForTasks()`:
   ```csharp
   await entity.WaitForTasks(cancellationToken);
   ```

2. **For save operations:** Pass `CancellationToken` to `Save()`:
   ```csharp
   await entity.Save(cancellationToken);
   ```

3. **For async rules:** Use the new fluent rule overloads:
   ```csharp
   RuleManager.AddActionAsync<T>(
       async (target, token) => await Operation(token),
       t => t.Property);
   ```

---

## Files Changed

### Modified (core framework)

| File | Changes |
|------|---------|
| `src/Neatoo/Internal/AsyncTasks.cs` | Added `WaitForCompletion(CancellationToken?)` overload |
| `src/Neatoo/ValidateBase.cs` | Added `WaitForTasks(CancellationToken)`, cancellation handling in `RunRules()` |
| `src/Neatoo/ValidateListBase.cs` | Added `WaitForTasks(CancellationToken)` overload |
| `src/Neatoo/IMetaProperties.cs` | Added `WaitForTasks(CancellationToken)` to interface |
| `src/Neatoo/Rules/RuleManager.cs` | Cancellation checks before rule execution, new fluent rule overloads |
| `src/Neatoo/Rules/RuleBase.cs` | Cancellation check in `RunRule()` |
| `src/Neatoo/Rules/AsyncRuleBase.cs` | Cancellation check in `RunRule()` |
| `src/Neatoo/EntityBase.cs` | Added `Save(CancellationToken)` overload |

### New (fluent rules)

| File | Purpose |
|------|---------|
| `src/Neatoo/Rules/ActionAsyncFluentRuleWithToken.cs` | Async action rule with CancellationToken |
| `src/Neatoo/Rules/AsyncFluentRuleWithToken.cs` | Async validation rule with CancellationToken |

---

## Test Results

All 1,594 tests pass, including 19 new cancellation-specific tests:

- `AsyncTasks_WaitForCompletion_CancellationToken_ThrowsWhenCancelled`
- `ValidateBase_WaitForTasks_CancellationToken_PropagatesCancellation`
- `ValidateBase_RunRules_Cancelled_MarksInvalid`
- `RuleManager_RunRules_ChecksCancellationBeforeEachRule`
- `RuleBase_RunRule_CancellationToken_ChecksBeforeExecution`
- `AsyncRuleBase_RunRule_CancellationToken_ChecksBeforeExecution`
- `EntityBase_Save_CancellationToken_CancelsBeforePersistence`
- `EntityBase_Save_CancellationToken_DoesNotCancelDuringPersistence`
- `ActionAsyncFluentRuleWithToken_PassesCancellationToken`
- `AsyncFluentRuleWithToken_PassesCancellationToken`
- (and 9 additional edge case tests)

---

## Dependencies

| Package | Version | Notes |
|---------|---------|-------|
| Neatoo.RemoteFactory | 10.1.1 | No changes required |

---

## Related Documentation

- [Validation and Rules Guide](../validation-and-rules.md) - Async rule patterns
- [Meta-Properties Reference](../meta-properties.md) - WaitForTasks documentation
- [Aggregates and Entities Guide](../aggregates-and-entities.md) - Save operation details
