# Neatoo 10.3.0

**Release Date:** TBD
**Type:** Feature Release
**Breaking Changes:** No

---

## Summary

This release adds aggregate boundary enforcement, improved entity lifecycle management, and collection safety:
- **Root property** prevents entities from being added to wrong aggregates
- **ContainingList property** ensures consistent Delete/Remove behavior and enables intra-aggregate moves
- **Add constraints** prevent null, duplicate, and busy items from being added to lists

---

## What's New

### Root Property for Aggregate Membership

Entities and entity lists now expose a `Root` property that identifies the aggregate root they belong to.

```csharp
public interface IEntityBase
{
    IBase? Parent { get; }  // Immediate parent
    IBase? Root { get; }    // Aggregate root (NEW)
}
```

**Behavior:**
- If `Parent` is null, entity is standalone or is the aggregate root, so `Root` is null
- If `Parent.Root` exists, returns that (parent knows its root)
- If `Parent.Root` is null, parent is the root, so returns `Parent`

**Example:**
```csharp
// Company (aggregate root)
//   └── Departments (list)
//       └── Dept1 (entity)
//           └── Projects (list)
//               └── Project1 (entity)

company.Root   // null (it IS the root)
dept1.Root     // Company
project1.Root  // Company
```

### Cross-Aggregate Boundary Enforcement

`EntityListBase` now validates that items being added belong to the same aggregate (or are new items with no aggregate yet).

```csharp
var company1 = factory.CreateCompany();
var company2 = factory.CreateCompany();

var dept = factory.CreateDepartment();
company1.Departments.Add(dept);  // OK - dept joins company1's aggregate

// Later attempt to add to different aggregate
company2.Departments.Add(dept);  // THROWS InvalidOperationException
// "Cannot add Department to list: item belongs to aggregate 'Company',
//  but this list belongs to aggregate 'Company'."
```

**Allowed scenarios:**
| Scenario | item.Root | list.Root | Result |
|----------|-----------|-----------|--------|
| Add brand new item | null | Company | Allowed |
| Add from same aggregate | Company | Company | Allowed |
| Add from different aggregate | Company1 | Company2 | Throws |
| Add to root-level list | Company | null | Allowed |

**Deserialization:** The check is skipped when `IsPaused=true` (during factory operations and JSON deserialization) since data from trusted sources doesn't need validation.

### ContainingList Property for Delete/Remove Consistency

Entities now track which list contains them via an internal `ContainingList` property. This enables:

1. **Delete/Remove consistency** - `entity.Delete()` and `list.Remove(entity)` now behave identically
2. **Intra-aggregate moves** - Entities can be moved between lists within the same aggregate

**Delete/Remove Consistency:**

Previously, calling `entity.Delete()` on an entity in a list had different behavior than calling `list.Remove(entity)`. Now both operations:
- Remove the entity from the list
- Mark it as deleted (`IsDeleted = true`)
- Add it to the `DeletedList` (if not new)

```csharp
// These are now equivalent:
order.LineItems.Remove(item);
item.Delete();
```

**Intra-Aggregate Moves:**

Entities can now be safely moved between lists within the same aggregate:

```csharp
// Company aggregate with two departments
var project = dept1.Projects[0];

// Remove from Dept1's projects
dept1.Projects.Remove(project);
// project.IsDeleted = true
// project in dept1.Projects.DeletedList

// Add to Dept2's projects (same aggregate)
dept2.Projects.Add(project);
// project removed from dept1.Projects.DeletedList
// project.IsDeleted = false (undeleted)
// project now in dept2.Projects
```

**Lifecycle:**

| State | ContainingList | IsDeleted | In DeletedList |
|-------|----------------|-----------|----------------|
| Active in list | Set | false | No |
| Removed (pending delete) | Set | true | Yes |
| After save | null | true | No |
| Brand new (never added) | null | false | No |

### Add Constraints

`EntityListBase` now validates items when adding to prevent invalid operations:

| Constraint | Exception | Message |
|------------|-----------|---------|
| Null item | `ArgumentNullException` | Parameter name: item |
| Duplicate item | `InvalidOperationException` | "item is already in this list" |
| Busy item | `InvalidOperationException` | "item is busy (async rules running)" |
| Cross-aggregate | `InvalidOperationException` | "item belongs to aggregate 'X', but this list belongs to aggregate 'Y'" |

```csharp
var list = company.Departments;

// Null - throws ArgumentNullException
list.Add(null!);

// Duplicate - throws InvalidOperationException
list.Add(dept);
list.Add(dept);  // Already in list

// Busy - throws InvalidOperationException
// (async rule is running on the department)
list.Add(busyDept);

// Cross-aggregate - throws InvalidOperationException
company2.Departments.Add(dept);  // dept belongs to company1
```

**Re-adding removed items:** When an item is removed from a list (via `Remove()` or `Delete()`), it can be re-added to the same list or moved to another list within the same aggregate. The duplicate check recognizes that a removed item is no longer "in" the list.

**Deserialization:** All constraints are skipped when `IsPaused=true` (during factory operations and JSON deserialization) since data from trusted sources doesn't need validation.

---

## Files Changed

### Modified
- `src/Neatoo/InternalInterfaces.cs` - Added `ContainingList`, `SetContainingList()`, `MarkDeleted()` to `IEntityBaseInternal`; added `RemoveFromDeletedList()` to `IEntityListBaseInternal`
- `src/Neatoo/EntityBase.cs` - Added `Root` property, `ContainingList` property, updated `Delete()` to delegate to list
- `src/Neatoo/EntityListBase.cs` - Added `Root` property, cross-aggregate check, `ContainingList` management, intra-aggregate move support, null/duplicate/busy item validation

### New Test Files
- `src/Neatoo.UnitTest/Integration/Concepts/EntityBase/RootPropertyTests.cs` - 13 tests for Root property
- `src/Neatoo.UnitTest/Integration/Concepts/EntityBase/ContainingListTests.cs` - 12 tests for ContainingList behavior
- `src/Neatoo.UnitTest/Integration/Concepts/EntityBase/EntityListBaseEdgeCaseTests.cs` - 11 tests for add constraints (null, duplicate, busy, re-add)
- `src/Neatoo.UnitTest/Integration/Concepts/EntityBase/EntityListBaseStateTransitionTests.cs` - 21 tests for state transitions when adding items

---

## Dependencies

| Package | Version | Notes |
|---------|---------|-------|
| Neatoo.RemoteFactory | 10.1.1 | No changes |

---

## Related Documentation

- [Root Property Implementation](../todos/completed/root-property-implementation.md)
- [ContainingList Property Implementation](../todos/completed/containinglist-property-implementation.md)
- [Delete/Remove Consistency](../todos/completed/entity-delete-vs-list-remove.md)
- [Add Use Cases](../todos/completed/entitylistbase-add-use-cases.md)
- [Aggregates and Entities Guide](../aggregates-and-entities.md) - Updated with Add constraints documentation
