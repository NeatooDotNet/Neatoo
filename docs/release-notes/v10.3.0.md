# Neatoo 10.3.0

**Release Date:** TBD
**Type:** Feature Release
**Breaking Changes:** No

---

## Summary

This release adds aggregate boundary enforcement through the new `Root` property, preventing entities from being accidentally added to wrong aggregates.

---

## What's New

### Root Property for Aggregate Membership

Entities and entity lists now expose a `Root` property that identifies the aggregate root they belong to.

```csharp
public interface IEntityBase
{
    IBase? Parent { get; }  // Immediate parent
    IBase? Root { get; }    // Aggregate root (NEW)
}
```

**Behavior:**
- If `Parent` is null, entity is standalone or is the aggregate root, so `Root` is null
- If `Parent.Root` exists, returns that (parent knows its root)
- If `Parent.Root` is null, parent is the root, so returns `Parent`

**Example:**
```csharp
// Company (aggregate root)
//   └── Departments (list)
//       └── Dept1 (entity)
//           └── Projects (list)
//               └── Project1 (entity)

company.Root   // null (it IS the root)
dept1.Root     // Company
project1.Root  // Company
```

### Cross-Aggregate Boundary Enforcement

`EntityListBase` now validates that items being added belong to the same aggregate (or are new items with no aggregate yet).

```csharp
var company1 = factory.CreateCompany();
var company2 = factory.CreateCompany();

var dept = factory.CreateDepartment();
company1.Departments.Add(dept);  // OK - dept joins company1's aggregate

// Later attempt to add to different aggregate
company2.Departments.Add(dept);  // THROWS InvalidOperationException
// "Cannot add Department to list: item belongs to aggregate 'Company',
//  but this list belongs to aggregate 'Company'."
```

**Allowed scenarios:**
| Scenario | item.Root | list.Root | Result |
|----------|-----------|-----------|--------|
| Add brand new item | null | Company | Allowed |
| Add from same aggregate | Company | Company | Allowed |
| Add from different aggregate | Company1 | Company2 | Throws |
| Add to root-level list | Company | null | Allowed |

**Deserialization:** The check is skipped when `IsPaused=true` (during factory operations and JSON deserialization) since data from trusted sources doesn't need validation.

---

## Files Changed

### Modified
- `src/Neatoo/EntityBase.cs` - Added `Root` to `IEntityBase` and `EntityBase<T>`
- `src/Neatoo/EntityListBase.cs` - Added `Root` to `IEntityListBase` and `EntityListBase<I>`, added cross-aggregate check

### New Test File
- `src/Neatoo.UnitTest/Integration/Concepts/EntityBase/RootPropertyTests.cs` - 13 tests

---

## Dependencies

| Package | Version | Notes |
|---------|---------|-------|
| Neatoo.RemoteFactory | 10.1.1 | No changes |

---

## Related Documentation

- [Root Property Implementation](../todos/root-property-implementation.md)
- [EntityListBase Add Use Cases](../todos/entitylistbase-add-use-cases.md)
