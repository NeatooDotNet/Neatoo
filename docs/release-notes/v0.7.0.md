# Neatoo 0.7.0

**Release Date:** 2026-01-11
**Type:** Feature Release
**Breaking Changes:** Yes (RuleIndex renamed to RuleId, AddRules removed)

---

## Summary

This release introduces **stable rule identification** via source generation. Rules are now assigned deterministic ordinal IDs at compile time based on their source expression, replacing the fragile runtime index-based system. This ensures rule messages are correctly matched after client-server serialization round-trips, even when rule registration order differs.

---

## What's New

### Stable Rule Identification

Previously, rules were identified by sequential indices assigned during registration. This broke when:
- Rules were registered in different order on client vs server
- Code changes added/removed rules, shifting indices

Now, the source generator assigns stable ordinal IDs based on the rule's source expression:

```csharp
public partial class Employee : EntityBase<Employee>
{
    public Employee(IEmailRule emailRule, ISalaryRule salaryRule)
    {
        // Each rule gets a stable ID based on its parameter name
        RuleManager.AddRule(emailRule);   // ID from "emailRule"
        RuleManager.AddRule(salaryRule);  // ID from "salaryRule"

        // Fluent rules get IDs from the lambda expression
        RuleManager.AddValidation(
            t => string.IsNullOrEmpty(t.Name) ? "Name required" : "",
            t => t.Name);
    }

    [Required]  // Attribute rules get IDs like "RequiredAttribute_Name"
    public partial string? Name { get; set; }
}
```

The generator produces a `GetRuleId` override:

```csharp
// Generated code
protected override uint GetRuleId(string sourceExpression)
{
    return sourceExpression switch
    {
        @"emailRule" => 1u,
        @"RequiredAttribute_Name" => 2u,
        @"salaryRule" => 3u,
        @"t => string.IsNullOrEmpty(t.Name) ? ""Name required"" : """"" => 4u,
        _ => base.GetRuleId(sourceExpression)
    };
}
```

### CallerArgumentExpression Integration

Rule registration methods now use `[CallerArgumentExpression]` to capture the source text of rule arguments at compile time:

```csharp
public TRule AddRule<TRule>(
    TRule rule,
    [CallerArgumentExpression("rule")] string? sourceExpression = null);

public ValidationFluentRule<T> AddValidation(
    Func<T, string> func,
    Expression<Func<T, object?>> triggerProperty,
    [CallerArgumentExpression("func")] string? sourceExpression = null);
```

### Hash Fallback for Unknown Expressions

For rules not known at compile time (e.g., dynamically registered), a deterministic FNV-1a hash provides the fallback ID:

```csharp
// Base class provides hash fallback
protected virtual uint GetRuleId(string sourceExpression)
{
    return Fnv1aHash(sourceExpression);
}
```

---

## Breaking Changes

### RuleIndex Renamed to RuleId

| Before | After |
|--------|-------|
| `IRuleMessage.RuleIndex` | `IRuleMessage.RuleId` |
| `IRule.UniqueIndex` | `IRule.RuleId` |

### AddRules Method Removed

The `AddRules(params IRule[] rules)` method has been removed. Use individual `AddRule` calls:

**Before:**
```csharp
RuleManager.AddRules(rule1, rule2, rule3);
```

**After:**
```csharp
RuleManager.AddRule(rule1);
RuleManager.AddRule(rule2);
RuleManager.AddRule(rule3);
```

### AddAction Signature Changes

`AddAction` now uses explicit overloads instead of `params` to support `CallerArgumentExpression`:

```csharp
// 1-3 triggers: natural syntax
RuleManager.AddAction(t => t.FullName = $"{t.First} {t.Last}", t => t.First, t => t.Last);

// 4+ triggers: explicit array
RuleManager.AddAction(
    t => t.Summary = Calculate(t),
    new[] { t => t.A, t => t.B, t => t.C, t => t.D });
```

---

## Migration Guide

### Recompile Required

After upgrading, recompile all projects that use Neatoo entities. The source generator will automatically generate `GetRuleId` overrides.

### Update Custom IRuleMessage Implementations

If you implement `IRuleMessage` directly:

```csharp
// Before
public uint RuleIndex { get; set; }

// After
public uint RuleId { get; set; }
```

### Update AddRules Calls

Search for `AddRules(` and replace with individual `AddRule` calls.

---

## New Generator Unit Tests

Added comprehensive unit tests for the BaseGenerator:
- `GetRuleIdGenerationTests` - 10 tests for rule ID generation
- `PartialPropertyGenerationTests` - 10 tests for property generation
- `MapModifiedToGenerationTests` - 6 tests for mapper generation

---

## Test Results

- **1918+ unit tests pass** including all existing tests
- **41 new StableRuleId serialization tests** verify round-trip stability
- **21 new edge case tests** cover stress scenarios
- **26 new generator unit tests** verify source generation

---

## Related Documentation

- [Rule Identification Internals](../advanced/rule-identification.md) - Deep dive into how stable IDs work
- [Validation and Rules Guide](../validation-and-rules.md) - Rule registration patterns
