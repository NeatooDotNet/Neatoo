# Neatoo 0.6.3

**Release Date:** 2026-01-10
**Type:** Patch Release (Code Quality)
**Breaking Changes:** None

---

## Summary

This release addresses code quality issues identified during a comprehensive code review. Fixes include a potential global state corruption bug, a collision issue in busy tracking, and various code clarity improvements.

---

## What's Fixed

### Mutable Static State Bug

`RuleMessages.None` and `IRuleMessages.None` were mutable static fields. Calling `.Add()` on these "empty" collections would corrupt global state, causing validation errors to appear on unrelated entities.

**Fix:** Changed to expression-bodied properties that return new instances:

```csharp
// Before (dangerous)
public static IRuleMessages None = new RuleMessages();

// After (safe)
public static IRuleMessages None => new RuleMessages();
```

### Busy Tracking Collision Issue

The unique execution ID for busy tracking used `UniqueIndex + Random.Shared.Next(10000, 100000)`, which could theoretically produce collisions between different rule executions.

**Fix:** Replaced with atomic counter using `Interlocked.Increment`:

```csharp
private static long _nextExecId = 0;
var uniqueExecIndex = Interlocked.Increment(ref _nextExecId);
```

---

## Code Quality Improvements

| Area | Change |
|------|--------|
| `RuleManager.ShouldRunRule()` | Extracted complex flag logic to documented static method |
| `RuleManager.RegisterRule<T>()` | DRY helper for rule registration (8 call sites) |
| `ValidateBase.RunRules()` | Simplified confusing bitwise expression |
| `RuleBase.OnRuleAdded()` | Clarified comment about static rule protection |
| `ValidateProperty` | Added comments explaining async busy-tracking pattern |

---

## Migration Guide

**No action required.** All changes are internal improvements with no API changes.

---

## Related Issues

Code quality issues identified and tracked in:
- `docs/todos/meta-state-notifier-service.md`
- `docs/todos/advanced-documentation.md`
- `docs/todos/runrulesflag-messages-bug.md`
- `docs/todos/remove-inconsistent-locks.md`
