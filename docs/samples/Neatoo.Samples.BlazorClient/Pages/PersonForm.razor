@page "/person-form"

@*
    Code samples for blazor-integration skill - Blazor binding patterns

    Snippets:
    - docs:blazor-integration:property-binding
    - docs:blazor-integration:validation-display
    - docs:blazor-integration:issavable-button
    - docs:blazor-integration:isbusy-handling
    - docs:blazor-integration:async-loading
    - docs:blazor-integration:save-pattern

    Note: Examples use standard Blazor. For MudBlazor, use MudTextField, MudButton, etc.
*@

<h3>Person Form</h3>

@if (Person is null)
{
    <p>Loading...</p>
}
else
{
    @* #region docs:blazor-integration:isbusy-handling *@
    @if (Person.IsBusy)
    {
        @* Show loading indicator while async rules execute *@
        <div class="spinner">Validating...</div>
    }
    @* #endregion *@

    <div class="form-group">
        @* #region docs:blazor-integration:property-binding *@
        @* Bind directly to entity properties - change notification is automatic *@
        <label>@Person[nameof(Person.FirstName)].DisplayName</label>
        <input type="text" @bind="Person.FirstName" @bind:event="oninput"
               class="@(Person[nameof(Person.FirstName)].IsValid ? "" : "is-invalid")" />
        @* #endregion *@

        @* #region docs:blazor-integration:validation-display *@
        @* Display validation messages from PropertyMessages collection *@
        @if (!Person[nameof(Person.FirstName)].IsValid)
        {
            @foreach (var message in Person[nameof(Person.FirstName)].PropertyMessages)
            {
                <div class="validation-error">@message.Message</div>
            }
        }
        @* #endregion *@
    </div>

    <div class="form-group">
        <label>@Person[nameof(Person.LastName)].DisplayName</label>
        <input type="text" @bind="Person.LastName" @bind:event="oninput"
               class="@(Person[nameof(Person.LastName)].IsValid ? "" : "is-invalid")" />
        @if (!Person[nameof(Person.LastName)].IsValid)
        {
            @foreach (var message in Person[nameof(Person.LastName)].PropertyMessages)
            {
                <div class="validation-error">@message.Message</div>
            }
        }
    </div>

    <div class="form-group">
        <label>@Person[nameof(Person.Email)].DisplayName</label>
        <input type="email" @bind="Person.Email" @bind:event="oninput"
               class="@(Person[nameof(Person.Email)].IsValid ? "" : "is-invalid")" />
        @if (!Person[nameof(Person.Email)].IsValid)
        {
            @foreach (var message in Person[nameof(Person.Email)].PropertyMessages)
            {
                <div class="validation-error">@message.Message</div>
            }
        }
    </div>

    @* #region docs:blazor-integration:issavable-button *@
    @* IsSavable checks: IsModified, IsValid, !IsBusy, !IsChild *@
    <button type="button"
            disabled="@(!Person.IsSavable)"
            @onclick="SavePerson">
        Save
    </button>
    @* #endregion *@

    <button type="button" @onclick="Cancel">Cancel</button>
}

@code {
    [Inject] private IPersonFactory PersonFactory { get; set; } = default!;

    private IPerson? Person { get; set; }

    @* #region docs:blazor-integration:async-loading *@
    protected override async Task OnInitializedAsync()
    {
        // Create a new entity using the factory
        Person = PersonFactory.Create();

        // For fetching existing: Person = await PersonFactory.Fetch(id);
        await base.OnInitializedAsync();
    }
    @* #endregion *@

    @* #region docs:blazor-integration:save-pattern *@
    private async Task SavePerson()
    {
        if (Person is null || !Person.IsSavable) return;

        // Wait for any async rules to complete
        await Person.WaitForTasks();

        // Re-check IsSavable after waiting
        if (!Person.IsSavable) return;

        // IMPORTANT: Always reassign - Save returns a new instance
        // Person = await PersonFactory.Save(Person);

        // Note: This sample Person entity doesn't have Insert/Update methods.
        // In a real entity with [Insert] and [Update] methods, the factory
        // generates a Save method that should be called like above.
    }
    @* #endregion *@

    private void Cancel()
    {
        // Navigate back or reset form
    }
}
